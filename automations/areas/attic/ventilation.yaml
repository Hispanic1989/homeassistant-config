---
#
# I've modified the existing Buva Q-Stream ventilation unit with ESPHome,
# an ESP8266 and a 0-10v PWM-to-Voltage module. The unit has a 0-10v port
# to set the speed and a 15v port to power the ESP and the module.
#
id: 'attic-ventilation'
alias: Afzuiging
description: 'Afzuiging aan bij douchen'
mode: single
variables:
  average_humidity: >-
    {% 
      set sensors = [
        states('sensor.lily_luchtvochtigheid')|float,
        states('sensor.olivia_luchtvochtigheid')|float
      ]
    %}
    {{ (sensors|sum / sensors|count)|float }}
  delta_humidity: >-
    {{
      states('sensor.slaapkamer_luchtvochtigheid')|float - average_humidity
    }}
trigger:
  - platform: homeassistant
    event: start
  - platform: event
    event_type: automation_reloaded
  - platform: state
    entity_id:
      - sensor.lily_luchtvochtigheid
      - sensor.olivia_luchtvochtigheid
      - sensor.slaapkamer_luchtvochtigheid
action:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ delta_humidity > 20 }}"
      sequence:
        - service: fan.turn_on
          data_template:
            entity_id: fan.afzuiging
        - service: fan.set_speed
          data_template:
            entity_id: fan.afzuiging
            speed: 'high'
    - conditions:
      - condition: template
        value_template: "{{ delta_humidity < 10 }}"
      sequence:
        - service: fan.turn_off
          data_template:
            entity_id: fan.afzuiging
